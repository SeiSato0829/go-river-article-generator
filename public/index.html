<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go-River 記事生成システム v2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0066FF;
            --primary-light: #E8F1FF;
            --primary-dark: #0052CC;
            --success: #00C48C;
            --success-light: #E6F9F4;
            --warning: #FF9500;
            --danger: #FF3B30;
            --text-primary: #1A1A2E;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --bg-primary: #FAFBFC;
            --bg-card: #FFFFFF;
            --border: #E5E7EB;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 12px 40px rgba(0,0,0,0.08);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--text-primary);
            text-decoration: none;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), #00C48C);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--success-light);
            border-radius: 100px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--success);
        }

        .api-status.disconnected {
            background: #FEF2F2;
            color: var(--danger);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .btn-settings {
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .btn-settings:hover {
            background: var(--bg-primary);
            color: var(--primary);
        }

        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .card-header { margin-bottom: 1.5rem; }
        .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem; }
        .card-subtitle { font-size: 0.875rem; color: var(--text-secondary); }

        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem; }
        .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.375rem; }

        .form-input, .form-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 640px) {
            .form-row { grid-template-columns: 1fr; }
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-primary); color: var(--text-primary); border: 1.5px solid var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { background: #00a676; }
        .btn-large { padding: 1.25rem 2rem; font-size: 1.125rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-group { display: flex; gap: 0.75rem; flex-wrap: wrap; }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-md);
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-primary);
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .upload-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 1rem;
            background: var(--primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon svg { width: 28px; height: 28px; color: var(--primary); }
        .upload-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .upload-hint { font-size: 0.875rem; color: var(--text-secondary); }

        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--success-light);
            border-radius: var(--radius-sm);
            margin-top: 1rem;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: var(--success);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .file-name { font-weight: 600; font-size: 0.9375rem; }
        .file-size { font-size: 0.8125rem; color: var(--text-secondary); }

        .preset-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .preset-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }

        .progress-container { margin: 1.5rem 0; }
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        .progress-step.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        .progress-step.completed {
            background: var(--success-light);
            color: var(--success);
        }

        .progress-step.error {
            background: #FEF2F2;
            color: var(--danger);
        }

        .step-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .output-section {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .output-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .output-title {
            font-weight: 600;
            font-size: 1rem;
        }

        .output-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.9375rem;
            line-height: 1.7;
        }

        .output-content.article-preview h1 { font-size: 1.5rem; margin-bottom: 1rem; }
        .output-content.article-preview h2 { font-size: 1.25rem; margin: 1.5rem 0 0.75rem; color: var(--primary); }
        .output-content.article-preview p { margin-bottom: 0.75rem; }

        .title-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .title-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .title-option:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .title-option .number {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .image-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .image-preview {
            aspect-ratio: 16/9;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-info {
            padding: 1rem;
        }

        .image-label {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .export-option {
            padding: 1.5rem 1rem;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-option:hover { border-color: var(--primary); background: var(--primary-light); }
        .export-option:disabled { opacity: 0.5; cursor: not-allowed; }

        .export-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 0.75rem;
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .export-title { font-weight: 600; font-size: 0.9375rem; margin-bottom: 0.25rem; }
        .export-desc { font-size: 0.75rem; color: var(--text-secondary); }

        .status-message {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-radius: var(--radius-sm);
            margin: 1rem 0;
        }

        .status-success { background: var(--success-light); color: #047857; }
        .status-error { background: #FEF2F2; color: var(--danger); }

        .hidden { display: none !important; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title { font-size: 1.25rem; font-weight: 600; }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .modal-body { padding: 1.5rem; }
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        @media (max-width: 768px) {
            .main { padding: 1rem; }
            .card { padding: 1.5rem; }
            .header-inner { flex-direction: column; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-inner">
            <a href="#" class="logo">
                <div class="logo-icon">GR</div>
                <span>Go-River 記事生成 v2</span>
            </a>
            <div class="header-actions">
                <div class="api-status disconnected" id="apiStatus">
                    <span class="status-dot"></span>
                    <span id="apiStatusText">未接続</span>
                </div>
                <button class="btn-settings" onclick="openSettings()" title="設定">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- API設定カード -->
        <div class="card" id="setupCard">
            <div class="card-header">
                <h2 class="card-title">API設定</h2>
                <p class="card-subtitle">Gemini APIキーを入力してください（画像生成は無料で利用可能）</p>
            </div>
            <div class="form-group">
                <label class="form-label">Gemini API Key</label>
                <input type="password" class="form-input" id="geminiKey" placeholder="AIzaSy...">
                <p class="form-hint">文字起こし・記事生成用（Google AI Studioで無料取得可能）</p>
            </div>
            <div class="status-message status-success" style="margin-bottom: 1rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>画像生成はPollinations AI（無料）を使用 - APIキー不要</span>
            </div>
            <button class="btn btn-primary" onclick="saveApiKeys()">設定を保存して開始</button>
        </div>

        <!-- メインカード -->
        <div class="card hidden" id="mainCard">
            <div class="card-header">
                <h2 class="card-title">音声ファイルをアップロード</h2>
                <p class="card-subtitle">音声をアップロードして「自動生成開始」を押すだけで、記事・画像が全て生成されます</p>
            </div>

            <!-- プリセット選択 -->
            <div class="form-group">
                <label class="form-label">プロンプトプリセット</label>
                <div class="preset-selector">
                    <button class="preset-btn active" onclick="selectPreset('company')" id="presetCompany">会社アカウント</button>
                    <button class="preset-btn" onclick="selectPreset('personal')" id="presetPersonal">個人アカウント</button>
                </div>
            </div>

            <!-- アップロードエリア -->
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('audioFile').click()">
                <div class="upload-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <p class="upload-title">クリックまたはドラッグ＆ドロップ</p>
                <p class="upload-hint">MP3, M4A, WAV, WebM, OGG に対応</p>
            </div>
            <input type="file" id="audioFile" accept="audio/*" style="display:none" onchange="handleFileSelect(event)">

            <div class="file-info hidden" id="fileInfo">
                <div class="file-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                </div>
                <div>
                    <div class="file-name" id="fileName"></div>
                    <div class="file-size" id="fileSize"></div>
                </div>
            </div>

            <div style="margin-top: 1.5rem;">
                <button class="btn btn-success btn-large" id="btnAutoGenerate" disabled onclick="startAutoGeneration()" style="width: 100%;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    自動生成開始（ワンクリック）
                </button>
            </div>
        </div>

        <!-- 進捗カード -->
        <div class="card hidden" id="progressCard">
            <div class="card-header">
                <h2 class="card-title">生成中...</h2>
                <p class="card-subtitle" id="progressSubtitle">全工程を自動で処理しています</p>
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="progressStatus">準備中...</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            <div class="progress-steps" id="progressSteps">
                <div class="progress-step" id="step-transcribe">
                    <span class="step-icon">1</span>
                    <span>文字起こし</span>
                </div>
                <div class="progress-step" id="step-article">
                    <span class="step-icon">2</span>
                    <span>記事生成</span>
                </div>
                <div class="progress-step" id="step-title">
                    <span class="step-icon">3</span>
                    <span>タイトル生成</span>
                </div>
                <div class="progress-step" id="step-summary">
                    <span class="step-icon">4</span>
                    <span>概要文＋ハッシュタグ</span>
                </div>
                <div class="progress-step" id="step-eyecatch">
                    <span class="step-icon">5</span>
                    <span>アイキャッチ画像</span>
                </div>
                <div class="progress-step" id="step-diagrams">
                    <span class="step-icon">6</span>
                    <span>図解画像</span>
                </div>
            </div>
        </div>

        <!-- 結果カード -->
        <div class="card hidden" id="resultCard">
            <div class="card-header">
                <h2 class="card-title">生成完了</h2>
                <p class="card-subtitle">全ての生成が完了しました</p>
            </div>

            <!-- タイトル案 -->
            <div class="output-section">
                <div class="output-header">
                    <span class="output-title">タイトル案（3パターン）</span>
                    <button class="btn btn-secondary" onclick="copyTitles()" style="padding: 0.5rem 1rem; font-size: 0.8125rem;">コピー</button>
                </div>
                <div class="title-options" id="titleOptions"></div>
            </div>

            <!-- 概要文＋ハッシュタグ -->
            <div class="output-section">
                <div class="output-header">
                    <span class="output-title">概要文＋ハッシュタグ</span>
                    <button class="btn btn-secondary" onclick="copySummary()" style="padding: 0.5rem 1rem; font-size: 0.8125rem;">コピー</button>
                </div>
                <div class="output-content" id="summaryContent"></div>
            </div>

            <!-- 画像 -->
            <div class="output-section">
                <div class="output-header">
                    <span class="output-title">生成画像</span>
                </div>
                <div class="images-grid" id="imagesGrid"></div>
            </div>

            <!-- 記事本文 -->
            <div class="output-section">
                <div class="output-header">
                    <span class="output-title">記事本文</span>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="switchArticleTab('preview')">プレビュー</button>
                    <button class="tab" onclick="switchArticleTab('markdown')">Markdown</button>
                </div>
                <div class="output-content article-preview" id="articlePreview"></div>
                <div class="output-content hidden" id="articleMarkdown" style="font-family: monospace;"></div>
            </div>

            <!-- エクスポート -->
            <div class="output-section">
                <div class="output-header">
                    <span class="output-title">エクスポート</span>
                </div>
                <div class="export-grid">
                    <div class="export-option" onclick="exportComplete()" style="border-color: var(--success); background: var(--success-light);">
                        <div class="export-icon" style="background: var(--success); color: white;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </div>
                        <div class="export-title">完全版DL</div>
                        <div class="export-desc">記事+画像一体型HTML</div>
                    </div>
                    <div class="export-option" onclick="copyArticleForNote()">
                        <div class="export-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                        </div>
                        <div class="export-title">記事コピー</div>
                        <div class="export-desc">note用テキスト</div>
                    </div>
                    <div class="export-option" onclick="downloadEyecatch()">
                        <div class="export-icon" style="background: #FF6B35; color: white;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div class="export-title">アイキャッチ</div>
                        <div class="export-desc">PNG画像</div>
                    </div>
                    <div class="export-option" onclick="downloadAllImages()">
                        <div class="export-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                        </div>
                        <div class="export-title">全画像DL</div>
                        <div class="export-desc">アイキャッチ+図解</div>
                    </div>
                </div>
            </div>

            <div class="status-message status-success hidden" id="exportStatus">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span id="exportMessage"></span>
            </div>

            <div style="margin-top: 1.5rem; text-align: center;">
                <button class="btn btn-secondary" onclick="resetAll()">新しい音声で再生成</button>
            </div>
        </div>
    </main>

    <!-- 設定モーダル -->
    <div class="modal-overlay hidden" id="settingsModal" onclick="closeSettings(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">設定</h3>
                <button class="modal-close" onclick="closeSettings()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchSettingsTab('api')">APIキー</button>
                    <button class="tab" onclick="switchSettingsTab('prompts')">プロンプト</button>
                </div>

                <div id="settingsApi">
                    <div class="form-group">
                        <label class="form-label">Gemini API Key</label>
                        <input type="password" class="form-input" id="settingsGeminiKey" placeholder="AIzaSy...">
                        <p class="form-hint">文字起こし・記事生成用</p>
                    </div>
                    <div class="status-message status-success" style="margin-top: 1rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>画像生成: Pollinations AI（無料・APIキー不要）</span>
                    </div>
                </div>

                <div id="settingsPrompts" class="hidden">
                    <div class="form-group">
                        <label class="form-label">プリセット選択</label>
                        <div class="preset-selector">
                            <button class="preset-btn active" onclick="selectSettingsPreset('company')" id="settingsPresetCompany">会社アカウント</button>
                            <button class="preset-btn" onclick="selectSettingsPreset('personal')" id="settingsPresetPersonal">個人アカウント</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">記事生成プロンプト</label>
                        <textarea class="form-textarea" id="promptArticle" rows="8"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">タイトル生成プロンプト</label>
                        <textarea class="form-textarea" id="promptTitle" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">概要文＋ハッシュタグ生成プロンプト</label>
                        <textarea class="form-textarea" id="promptSummary" rows="4"></textarea>
                    </div>
                    <button class="btn btn-secondary" onclick="resetPrompts()" style="margin-top: 0.5rem;">デフォルトに戻す</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettings()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveSettings()">保存</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // API URLs
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';

        // Default prompts
        const DEFAULT_PROMPTS = {
            company: {
                article: `以下の文字起こしをもとに、noteの記事を執筆してください。

## 記事の方針
- 読者が楽しく読めるよう、わかりやすくて臨場感のある記事にしてください
- 冗長な部分は思い切ってカットしてください
- 適切な見出し（##, ###）を付けて読みやすくしてください

## 導入文について【重要】
- 記事冒頭には必ず合同会社Go-Riverの紹介を含めてください
- 例：「マーケティングを軸に戦略実行の両面でクライアントを支援する合同会社Go-River。このnoteでは、代表の行川と司会進行の竹田が、仕事や生活における考えを対話形式で深掘りしていきます。」

## 対話形式について
- 「**行川さん：**」「**竹田さん：**」の形式で会話を表現してください
- 話し言葉の自然さは残してください

## 図解指示について【重要】
- 視覚的に表現した方がわかりやすい箇所には「**＞＞図解＜＜**」と注意書きを入れてください
- 図解マーカーの後には、箇条書きで図解の内容案を記載してください
- 目安として、記事内に3〜4箇所程度

## CTA（記事末尾）
---
**Go-River について**
[記事のテーマに関連したGo-Riverの強みを1-2文で記載]
https://go-river.co.jp/`,
                title: `この対談コンテンツが多くの人にクリックしてもらえるよう、キャッチーで惹きのあるタイトルを3パターン考えてください。

出力形式:
1. タイトル案1
2. タイトル案2
3. タイトル案3

各タイトルは30文字以内で、具体的かつ興味を引く表現にしてください。`,
                summary: `この対談コンテンツを音声プラットフォームで配信します。本編を聞きたくなるような魅力的な概要文と、適切なハッシュタグ案を考えてください。

出力形式:
【概要文】
（200文字程度の概要文）

【ハッシュタグ】
#タグ1 #タグ2 #タグ3 ...

※ハッシュタグは5〜8個程度`
            },
            personal: {
                article: `以下の文字起こしをもとに、noteの記事を執筆してください。

## 記事の方針
- 読者が楽しく読めるよう、わかりやすくて臨場感のある記事にしてください
- 冗長な部分は思い切ってカットしてください
- 適切な見出し（##, ###）を付けて読みやすくしてください

## 導入文について
- 記事冒頭には簡単な自己紹介と、今回のテーマを紹介してください

## 対話形式について
- 「**行川：**」「**竹田：**」の形式で会話を表現してください
- 話し言葉の自然さは残してください

## 図解指示について【重要】
- 視覚的に表現した方がわかりやすい箇所には「**＞＞図解＜＜**」と注意書きを入れてください
- 図解マーカーの後には、箇条書きで図解の内容案を記載してください
- 目安として、記事内に3〜4箇所程度`,
                title: `この対談コンテンツが多くの人にクリックしてもらえるよう、キャッチーで惹きのあるタイトルを3パターン考えてください。

出力形式:
1. タイトル案1
2. タイトル案2
3. タイトル案3

各タイトルは30文字以内で、具体的かつ興味を引く表現にしてください。`,
                summary: `この対談コンテンツを音声プラットフォームで配信します。本編を聞きたくなるような魅力的な概要文と、適切なハッシュタグ案を考えてください。

出力形式:
【概要文】
（200文字程度の概要文）

【ハッシュタグ】
#タグ1 #タグ2 #タグ3 ...

※ハッシュタグは5〜8個程度`
            }
        };

        // State
        let state = {
            audioFile: null,
            audioBase64: null,
            transcription: '',
            article: '',
            titles: [],
            summary: '',
            eyecatch: null,
            diagrams: [],
            geminiKey: '',
            currentPreset: 'company',
            prompts: JSON.parse(JSON.stringify(DEFAULT_PROMPTS))
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();

            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            });
        });

        function loadSettings() {
            state.geminiKey = localStorage.getItem('goriver-gemini-key') || '';
            state.currentPreset = localStorage.getItem('goriver-preset') || 'company';

            const savedPrompts = localStorage.getItem('goriver-prompts');
            if (savedPrompts) {
                state.prompts = JSON.parse(savedPrompts);
            }

            document.getElementById('geminiKey').value = state.geminiKey;

            if (state.geminiKey) {
                updateApiStatus(true);
                document.getElementById('setupCard').classList.add('hidden');
                document.getElementById('mainCard').classList.remove('hidden');
            }

            updatePresetUI();
        }

        function saveApiKeys() {
            state.geminiKey = document.getElementById('geminiKey').value.trim();

            if (!state.geminiKey) { alert('Gemini APIキーを入力してください'); return; }

            localStorage.setItem('goriver-gemini-key', state.geminiKey);

            updateApiStatus(true);
            document.getElementById('setupCard').classList.add('hidden');
            document.getElementById('mainCard').classList.remove('hidden');
        }

        function updateApiStatus(connected) {
            const status = document.getElementById('apiStatus');
            const text = document.getElementById('apiStatusText');
            status.classList.toggle('disconnected', !connected);
            text.textContent = connected ? 'API接続済み' : '未接続';
        }

        function selectPreset(preset) {
            state.currentPreset = preset;
            localStorage.setItem('goriver-preset', preset);
            updatePresetUI();
        }

        function updatePresetUI() {
            document.getElementById('presetCompany').classList.toggle('active', state.currentPreset === 'company');
            document.getElementById('presetPersonal').classList.toggle('active', state.currentPreset === 'personal');
        }

        function handleFileSelect(event) {
            if (event.target.files.length) handleFile(event.target.files[0]);
        }

        function handleFile(file) {
            state.audioFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('btnAutoGenerate').disabled = false;

            const reader = new FileReader();
            reader.onload = (e) => { state.audioBase64 = e.target.result.split(',')[1]; };
            reader.readAsDataURL(file);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Gemini API call
        async function callGeminiAPI(prompt, audioData = null, mimeType = null) {
            const parts = [{ text: prompt }];
            if (audioData && mimeType) {
                parts.push({ inline_data: { mime_type: mimeType, data: audioData } });
            }

            const response = await fetch(`${GEMINI_API_URL}?key=${state.geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts }],
                    generationConfig: { temperature: 0.5, maxOutputTokens: 8192 }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Gemini API Error');
            }

            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.map(p => p.text).join('') || '';
        }

        // Pollinations AI - 完全無料・APIキー不要
        async function callImageAPI(prompt) {
            const response = await fetch('/.netlify/functions/image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Image generation failed');
            }

            const data = await response.json();
            return data.url;
        }

        // Main auto-generation function
        async function startAutoGeneration() {
            document.getElementById('mainCard').classList.add('hidden');
            document.getElementById('progressCard').classList.remove('hidden');
            document.getElementById('btnAutoGenerate').disabled = true;

            const steps = ['transcribe', 'article', 'title', 'summary', 'eyecatch', 'diagrams'];
            let currentStep = 0;

            function updateProgress(step, status) {
                const stepEl = document.getElementById(`step-${step}`);
                stepEl.classList.remove('active', 'completed', 'error');
                stepEl.classList.add(status);

                if (status === 'active') {
                    stepEl.querySelector('.step-icon').innerHTML = '<div class="spinner"></div>';
                } else if (status === 'completed') {
                    stepEl.querySelector('.step-icon').innerHTML = '✓';
                } else if (status === 'error') {
                    stepEl.querySelector('.step-icon').innerHTML = '✗';
                }

                const progress = Math.round((currentStep / steps.length) * 100);
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressPercent').textContent = progress + '%';
            }

            try {
                // Step 1: Transcription
                updateProgress('transcribe', 'active');
                document.getElementById('progressStatus').textContent = '文字起こし中...';

                const transcriptionPrompt = `添付した音声は、合同会社Go-Riverの行川（なめかわ）さんと竹田（たけだ）さんの対談音声です。
話者を分けて文字起こししてください。
文字起こしした内容で違和感のある点は、意味が通るように修正してください。

出力形式:
- 話者名: 発言内容
の形式で出力してください。`;

                state.transcription = await callGeminiAPI(transcriptionPrompt, state.audioBase64, state.audioFile.type || 'audio/mp4');
                updateProgress('transcribe', 'completed');
                currentStep++;

                // Step 2: Article generation
                updateProgress('article', 'active');
                document.getElementById('progressStatus').textContent = '記事生成中...';

                const articlePrompt = state.prompts[state.currentPreset].article + '\n\n---\n以下が文字起こしの内容です：\n\n' + state.transcription;
                state.article = await callGeminiAPI(articlePrompt);
                updateProgress('article', 'completed');
                currentStep++;

                // Step 3: Title generation
                updateProgress('title', 'active');
                document.getElementById('progressStatus').textContent = 'タイトル生成中...';

                const titlePrompt = state.prompts[state.currentPreset].title + '\n\n---\n以下が記事の内容です：\n\n' + state.article.substring(0, 2000);
                const titleResult = await callGeminiAPI(titlePrompt);
                state.titles = titleResult.match(/\d\.\s*(.+)/g)?.map(t => t.replace(/^\d\.\s*/, '')) || [titleResult];
                updateProgress('title', 'completed');
                currentStep++;

                // Step 4: Summary + hashtags
                updateProgress('summary', 'active');
                document.getElementById('progressStatus').textContent = '概要文生成中...';

                const summaryPrompt = state.prompts[state.currentPreset].summary + '\n\n---\n以下が記事の内容です：\n\n' + state.article.substring(0, 2000);
                state.summary = await callGeminiAPI(summaryPrompt);
                updateProgress('summary', 'completed');
                currentStep++;

                // Step 5: Eyecatch image
                updateProgress('eyecatch', 'active');
                document.getElementById('progressStatus').textContent = 'アイキャッチ画像生成中...';

                try {
                    const titleForImage = state.titles[0] || '対談記事';
                    const eyecatchPrompt = `Professional business article header image for: "${titleForImage}"

Style: Clean, modern, corporate design with gradient blue (#0066FF) to teal (#00C48C) background. Abstract geometric shapes, professional atmosphere. NO text, NO letters, NO words. Suitable for marketing/consulting company content. High quality, sophisticated.`;

                    const eyecatchUrl = await callImageAPI(eyecatchPrompt);
                    state.eyecatch = eyecatchUrl;
                    updateProgress('eyecatch', 'completed');
                } catch (error) {
                    console.error('Eyecatch error:', error);
                    updateProgress('eyecatch', 'error');
                }
                currentStep++;

                // Step 6: Diagram images
                updateProgress('diagrams', 'active');
                document.getElementById('progressStatus').textContent = '図解画像生成中...';

                const diagramMatches = state.article.match(/\*\*＞＞図解＜＜\*\*[\s\S]*?(?=\n\n|$)/g) || [];
                state.diagrams = [];

                for (let i = 0; i < diagramMatches.length; i++) {
                    try {
                        const diagramContent = diagramMatches[i];
                        const diagramPrompt = `Create an infographic/diagram image for this concept:

${diagramContent}

Style: Clean business infographic with blue (#0066FF) and green (#00C48C) accents. White/light gray background. Simple icons, arrows, and boxes showing relationships. Professional corporate style. Text should be minimal and in Japanese if needed. Clear visual hierarchy.`;

                        const diagramUrl = await callImageAPI(diagramPrompt);
                        state.diagrams.push({ index: i, url: diagramUrl, content: diagramContent });
                    } catch (error) {
                        console.error(`Diagram ${i} error:`, error);
                        state.diagrams.push({ index: i, url: null, content: diagramMatches[i], error: true });
                    }
                }

                updateProgress('diagrams', 'completed');
                currentStep++;

                // Show results
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressPercent').textContent = '100%';
                document.getElementById('progressStatus').textContent = '完了！';

                setTimeout(() => {
                    document.getElementById('progressCard').classList.add('hidden');
                    showResults();
                }, 1000);

            } catch (error) {
                console.error('Generation error:', error);
                alert('エラーが発生しました: ' + error.message);
                document.getElementById('progressStatus').textContent = 'エラー: ' + error.message;
                document.getElementById('mainCard').classList.remove('hidden');
                document.getElementById('progressCard').classList.add('hidden');
                document.getElementById('btnAutoGenerate').disabled = false;
            }
        }

        function showResults() {
            document.getElementById('resultCard').classList.remove('hidden');

            // Titles
            const titlesEl = document.getElementById('titleOptions');
            titlesEl.innerHTML = state.titles.map((title, i) => `
                <div class="title-option" onclick="copyText('${title.replace(/'/g, "\\'")}')">
                    <span class="number">${i + 1}</span>
                    <span>${title}</span>
                </div>
            `).join('');

            // Summary
            document.getElementById('summaryContent').textContent = state.summary;

            // Images
            const imagesEl = document.getElementById('imagesGrid');
            let imagesHTML = '';

            if (state.eyecatch) {
                imagesHTML += `
                    <div class="image-card">
                        <div class="image-preview">
                            <img src="${state.eyecatch}" alt="アイキャッチ">
                        </div>
                        <div class="image-info">
                            <div class="image-label">アイキャッチ画像</div>
                            <button class="btn btn-secondary" onclick="downloadImage('${state.eyecatch}', 'eyecatch.png')" style="width:100%; padding: 0.5rem;">ダウンロード</button>
                        </div>
                    </div>
                `;
            }

            state.diagrams.forEach((d, i) => {
                if (d.url) {
                    imagesHTML += `
                        <div class="image-card">
                            <div class="image-preview">
                                <img src="${d.url}" alt="図解${i + 1}">
                            </div>
                            <div class="image-info">
                                <div class="image-label">図解 ${i + 1}</div>
                                <button class="btn btn-secondary" onclick="downloadImage('${d.url}', 'diagram-${i + 1}.png')" style="width:100%; padding: 0.5rem;">ダウンロード</button>
                            </div>
                        </div>
                    `;
                } else {
                    imagesHTML += `
                        <div class="image-card">
                            <div class="image-preview" style="background: #FEF2F2; color: var(--danger);">
                                生成失敗
                            </div>
                            <div class="image-info">
                                <div class="image-label">図解 ${i + 1}</div>
                            </div>
                        </div>
                    `;
                }
            });

            imagesEl.innerHTML = imagesHTML || '<p style="color: var(--text-muted);">画像はありません</p>';

            // Article
            document.getElementById('articlePreview').innerHTML = marked.parse(state.article);
            document.getElementById('articleMarkdown').textContent = state.article;
        }

        function switchArticleTab(tab) {
            document.querySelectorAll('#resultCard .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('articlePreview').classList.toggle('hidden', tab !== 'preview');
            document.getElementById('articleMarkdown').classList.toggle('hidden', tab === 'preview');
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => showExportSuccess('コピーしました'));
        }

        function copyTitles() {
            navigator.clipboard.writeText(state.titles.join('\n')).then(() => showExportSuccess('タイトル案をコピーしました'));
        }

        function copySummary() {
            navigator.clipboard.writeText(state.summary).then(() => showExportSuccess('概要文をコピーしました'));
        }

        function copyArticleForNote() {
            if (!state.article) {
                alert('記事がまだ生成されていません');
                return;
            }

            let noteContent = state.article;

            // Replace diagram markers with placeholders
            const diagramPattern = /\*\*＞＞図解＜＜\*\*[\s\S]*?(?=\n\n|\n##|$)/g;
            let diagramIndex = 0;
            noteContent = noteContent.replace(diagramPattern, () => {
                diagramIndex++;
                return `\n\n**【図解${diagramIndex}】**\n`;
            });

            noteContent = noteContent.replace(/\n{3,}/g, '\n\n').trim();

            navigator.clipboard.writeText(noteContent).then(() => {
                showExportSuccess('note用にコピーしました');
                if (state.diagrams.length > 0) {
                    setTimeout(() => {
                        if (confirm(`図解が${state.diagrams.length}個あります。\nnoteに貼り付けた後、【図解1】などの位置に画像をアップロードしてください。\n\n今すぐ図解をダウンロードしますか？`)) {
                            downloadAllImages();
                        }
                    }, 300);
                }
            });
        }

        async function downloadImage(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                URL.revokeObjectURL(a.href);
            } catch (error) {
                window.open(url, '_blank');
            }
        }

        function downloadEyecatch() {
            if (state.eyecatch) {
                downloadImage(state.eyecatch, 'eyecatch.png');
                showExportSuccess('アイキャッチをダウンロードしました');
            } else {
                alert('アイキャッチ画像がありません');
            }
        }

        function downloadAllImages() {
            if (state.eyecatch) {
                downloadImage(state.eyecatch, 'eyecatch.png');
            }
            state.diagrams.forEach((d, i) => {
                if (d.url) {
                    setTimeout(() => downloadImage(d.url, `diagram-${i + 1}.png`), (i + 1) * 500);
                }
            });
            showExportSuccess('全画像をダウンロード中...');
        }

        async function exportComplete() {
            if (!state.article) {
                alert('記事がまだ生成されていません');
                return;
            }

            // Convert article to HTML
            let articleHTML = marked.parse(state.article);

            // Replace diagram markers with image placeholders
            const diagramPattern = /\*\*＞＞図解＜＜\*\*[\s\S]*?(?=\n\n|\n##|$)/g;
            let diagramIndex = 0;
            articleHTML = articleHTML.replace(/<p>\*\*＞＞図解＜＜\*\*[\s\S]*?<\/p>/g, () => {
                const diagram = state.diagrams[diagramIndex];
                diagramIndex++;
                if (diagram && diagram.url) {
                    return `<div class="diagram-container"><img src="${diagram.url}" alt="図解${diagramIndex}"></div>`;
                }
                return `<div class="diagram-placeholder">【図解${diagramIndex}】</div>`;
            });

            // Create full HTML
            const fullHTML = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${state.titles[0] || 'Go-River 記事'}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.8;
            color: #333;
            background: #f5f5f5;
            padding: 2rem;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .eyecatch {
            margin: -3rem -3rem 2rem -3rem;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }
        .eyecatch img {
            width: 100%;
            height: auto;
            display: block;
        }
        h1 { font-size: 1.75rem; margin-bottom: 1.5rem; color: #1a1a2e; border-bottom: 3px solid #0066FF; padding-bottom: 0.5rem; }
        h2 { font-size: 1.35rem; margin: 2rem 0 1rem; color: #0066FF; }
        h3 { font-size: 1.15rem; margin: 1.5rem 0 0.75rem; color: #333; }
        p { margin-bottom: 1rem; }
        strong { color: #0066FF; }
        ul, ol { margin: 1rem 0 1rem 1.5rem; }
        li { margin-bottom: 0.5rem; }
        hr { border: none; border-top: 1px solid #e5e7eb; margin: 2rem 0; }
        a { color: #0066FF; text-decoration: none; }
        .diagram-container {
            margin: 2rem 0;
            text-align: center;
        }
        .diagram-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .diagram-placeholder {
            margin: 2rem 0;
            padding: 2rem;
            background: #f8fafc;
            border-radius: 8px;
            text-align: center;
            color: #6b7280;
        }
        .meta {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .meta-title { font-weight: 600; margin-bottom: 0.5rem; }
        .meta-content { color: #6b7280; font-size: 0.9375rem; }
        .footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 2px solid #0066FF;
            text-align: center;
            color: #666;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        ${state.eyecatch ? `<div class="eyecatch"><img src="${state.eyecatch}" alt="アイキャッチ"></div>` : ''}
        <div class="meta">
            <div class="meta-title">タイトル案</div>
            <div class="meta-content">${state.titles.join(' / ')}</div>
        </div>
        <div class="meta">
            <div class="meta-title">概要文＋ハッシュタグ</div>
            <div class="meta-content">${state.summary.replace(/\n/g, '<br>')}</div>
        </div>
        ${articleHTML}
        <div class="footer">
            <p>Generated by Go-River Article System v2</p>
        </div>
    </div>
</body>
</html>`;

            const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'go-river-article-complete.html';
            a.click();
            showExportSuccess('完全版HTMLをダウンロードしました');
        }

        function showExportSuccess(message) {
            const status = document.getElementById('exportStatus');
            document.getElementById('exportMessage').textContent = message;
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        }

        function resetAll() {
            state.audioFile = null;
            state.audioBase64 = null;
            state.transcription = '';
            state.article = '';
            state.titles = [];
            state.summary = '';
            state.eyecatch = null;
            state.diagrams = [];

            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('btnAutoGenerate').disabled = true;
            document.getElementById('resultCard').classList.add('hidden');
            document.getElementById('mainCard').classList.remove('hidden');

            // Reset progress steps
            ['transcribe', 'article', 'title', 'summary', 'eyecatch', 'diagrams'].forEach((step, i) => {
                const el = document.getElementById(`step-${step}`);
                el.classList.remove('active', 'completed', 'error');
                el.querySelector('.step-icon').textContent = i + 1;
            });
        }

        // Settings Modal
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsGeminiKey').value = state.geminiKey;
            loadPromptSettings();
        }

        function closeSettings(event) {
            if (!event || event.target === document.getElementById('settingsModal')) {
                document.getElementById('settingsModal').classList.add('hidden');
            }
        }

        function switchSettingsTab(tab) {
            document.querySelectorAll('#settingsModal .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('settingsApi').classList.toggle('hidden', tab !== 'api');
            document.getElementById('settingsPrompts').classList.toggle('hidden', tab === 'api');
        }

        function selectSettingsPreset(preset) {
            document.getElementById('settingsPresetCompany').classList.toggle('active', preset === 'company');
            document.getElementById('settingsPresetPersonal').classList.toggle('active', preset === 'personal');
            loadPromptSettings(preset);
        }

        function loadPromptSettings(preset = state.currentPreset) {
            document.getElementById('promptArticle').value = state.prompts[preset].article;
            document.getElementById('promptTitle').value = state.prompts[preset].title;
            document.getElementById('promptSummary').value = state.prompts[preset].summary;
        }

        function resetPrompts() {
            const preset = document.getElementById('settingsPresetCompany').classList.contains('active') ? 'company' : 'personal';
            state.prompts[preset] = JSON.parse(JSON.stringify(DEFAULT_PROMPTS[preset]));
            loadPromptSettings(preset);
        }

        function saveSettings() {
            state.geminiKey = document.getElementById('settingsGeminiKey').value.trim();

            const preset = document.getElementById('settingsPresetCompany').classList.contains('active') ? 'company' : 'personal';
            state.prompts[preset].article = document.getElementById('promptArticle').value;
            state.prompts[preset].title = document.getElementById('promptTitle').value;
            state.prompts[preset].summary = document.getElementById('promptSummary').value;

            localStorage.setItem('goriver-gemini-key', state.geminiKey);
            localStorage.setItem('goriver-prompts', JSON.stringify(state.prompts));

            updateApiStatus(!!state.geminiKey);

            if (state.geminiKey) {
                document.getElementById('setupCard').classList.add('hidden');
                document.getElementById('mainCard').classList.remove('hidden');
            }

            closeSettings();
            alert('設定を保存しました');
        }
    </script>
</body>
</html>
